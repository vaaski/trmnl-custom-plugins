# https://taskfile.dev

version: "3"

dotenv: [".env"]

vars:
  DOCKER_TAG: ghcr.io/vaaski/trmnl-custom-plugins:latest
  DOCKER_ENV_FLAGS: >-
    -e TRMNL_API_KEY=$TRMNL_API_KEY
    -e TRMNL_ENDPOINT_NEWS=$TRMNL_ENDPOINT_NEWS
    -e TRMNL_ENDPOINT_OBSIDIAN=$TRMNL_ENDPOINT_OBSIDIAN
    -e TRMNL_ENDPOINT_HASS=$TRMNL_ENDPOINT_HASS
  DOCKER_TRMNLP_FLAGS: --rm --name trmnlp --net host {{.DOCKER_ENV_FLAGS}}

tasks:
  bun:dev:
    cmds:
      - bun run dev

  trmnl:serve:obsidian:
    cmds:
      - docker run -v $(PWD)/trmnl-plugin/obsidian:/plugin {{.DOCKER_TRMNLP_FLAGS}} trmnl/trmnlp

  trmnl:serve:hass-temp:
    cmds:
      - docker run -v $(PWD)/trmnl-plugin/hass-temp:/plugin {{.DOCKER_TRMNLP_FLAGS}} trmnl/trmnlp

  trmnl:serve:news:
    cmds:
      - docker run -v $(PWD)/trmnl-plugin/news:/plugin {{.DOCKER_TRMNLP_FLAGS}} trmnl/trmnlp

  dev:obsidian:
    deps: [bun:dev, trmnl:serve:obsidian]

  dev:hass-temp:
    deps: [bun:dev, trmnl:serve:hass-temp]

  dev:news:
    deps: [bun:dev, trmnl:serve:news]

# ------------------------------------------------------------------------------

  docker:build:
    cmds:
      - docker build -t {{.DOCKER_TAG}} .

  docker:run:
    cmds:
      - docker run --rm -it -p 7834:7834 -e TRMNL_API_KEY=$TRMNL_API_KEY -v $OBSIDIAN_DAILY_NOTES_PATH:/notes {{.DOCKER_TAG}}
